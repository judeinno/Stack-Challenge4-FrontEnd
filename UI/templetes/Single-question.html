<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Title</title>
        <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0">
        <link rel="stylesheet" type="text/css" href="../static/main.css">
        <script src="../scripts/nav.js"></script>
    </head>
    <body>
        <div id = "logo">
                <h1>StackOverFlow-lite</h1>
        </div>
        <div class="nav" id="mynav">
              <a href="index.html" class="active">Home</a>
              <a href="All-question.html">All questions</a>
              <a href="signin.html">Sign Out</a>
              <a href="javascript:void(0);" class="icon" onclick="myFunction()">
                More
              </a>
        </div>
        <div class="content">
            <div id="questions">
                <div class="container">
                    <div class="row no-collapse-1">
                        <section class="single-question">
                            <div id="actual-question" class="actual-question"></div>

                        </section>
                    </div>
                    <div class="question-content">
                        <div id="asked-qn"></div><button id="delete" type="submit">Delete Question</button>
                        <div id="answers-sector">
                            <p>Click on a question to view or add an answer to it.</p>
                        </div>
                        <form  id="postanswer">
                            <input type="text" id="Answer" placeholder="Add an answer to this question ...">
                            <input id ="submit-answer" type="submit" value="Submit">
                        </form>
                    </div>
            </div>
        </div>
        <div>
            <footer id="footer">
                <p class="slogan"><br><br><br>StackOverFlow-lite, Ask anything!</p>
                <p>2018 StackOverFlow-lite</p>
            </footer>
        </div>
        </div>
        <script>
            document.getElementById("actual-question")
            token = localStorage.getItem('token')
            let url_var = window.location.href
            let url = new URL(url_var)
            let qn_id = url.searchParams.get("questionId")
            localStorage.setItem('qn_id', qn_id)
            qnId = localStorage.getItem('qn_id')
            getQuestion(qnId)
            function getQuestion(qnId){
                console.log(qnId)
                fetch('http://127.0.0.1:5000/api/v1/questions/'+ qnId,{headers: {"Authorization":` Bearer ${token}`}})
                .then((res) => res.json())
                .then((data) => {
                    let output = '<h2>Your Question is:</h2>';
                    console.log(data)
                    console.log(data["Your_question_is"][0]["Question"])
                    let MyQuestion = data["Your_question_is"][0]["Question"]
                    let MyAnswers = data["Your_question_is"]

                    if(MyAnswers && MyAnswers.length ){
                            for(i=0; i<MyAnswers.length; i++){
                            let myanswer = (MyAnswers[i]["Answer"])
                            let status = (MyAnswers[i]["Prefered_Ans_Status"])
                            output += `
                            <hr>
                            <ul class="questions">
                                <li>${MyQuestion}</li>
                            </ul>
                            <hr>
                            <ul class="questions">
                                <li>${myanswer}</li>
                                <li>Prefered_Ans_Status:  <button placeholder="Status">${status}</button></li>
                            </ul>

                        `;
                        }
                    }
                    else{
                        output += `
                            <hr>
                            <ul class="questions">
                                <li>${MyQuestion}</li>
                            </ul>
                            <hr>`;
                    }

                    document.getElementById('actual-question').innerHTML = output;


                })
            }

            document.getElementById("postanswer").addEventListener("submit", answerPost);
            function answerPost(e) {
                 e.preventDefault();
                let qnId = localStorage.getItem("qn_id");
                let Answer = document.getElementById("Answer").value;
                console.log(Answer);
                data = {
                    'Answer': Answer,
                };
                fetch('http://127.0.0.1:5000/api/v1/questions/'+ qnId + '/answers', {
                    method: "post",
                    body: JSON.stringify(data),
                    headers: {
                        "Accept": "application/json, text/plain, */*",
                        "Content-Type": "application/json",
                        "Authorization":` Bearer ${token}`
                    }
                })
                .then(res => res.json())
                .then(response => {
                    console.log(response)
                    if (response.message === "Token has expired") {
                        alert('Token has expired');
                        window.location.replace('signin.html');}
                    else if (response.message === 'Invalid, Please enter a valid answer') {
                        alert("Invalid, Please enter a valid answer");
                        window.location.replace('Single-question.html');
                    }
                    else if (response.message === 'answer successfully created') {
                        alert("answer successfully created");
                    }

                }
                )
                .catch(error => console.error("Error:", error));
            }

            document.getElementById("delete").addEventListener("click", deleteqn);
            function deleteqn() {
                let qnDelete = localStorage.getItem("qn_id");
                fetch('http://127.0.0.1:5000/api/v1/questions/' + qnDelete, {
                        method: 'DELETE',
                        headers: {
                            'Accept': 'application/json, text/plain, */*',
                            'Content-type': 'application/json',
                            "Authorization":` Bearer ${token}`
                        }
                    })
                    .then((res) => res.json())
                    .then((res) => {
                        if (res.message === "Question deleted successfully") {
                            console.log(res);
                            alert(res.message);
                            window.location.href = 'All-question.html'
                        }
                    })
            }

        </script>
    </body>
</html>